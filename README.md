# talk

![](https://upimage.alexhchu.com/2020/05/09/a3d10c630a08f.gif)

https://talk.bearye.cn

## 一、介绍

灵感来自 [b言b语](https://sspai.com/post/60024) ，作为个人说说站点，其提供了ios端捷径与win端quicker发布说说。本项目联合静态托管+云函数+NoSQL+微信公众号开发建立，实现微信向公众号发消息即可发布说说的功能，全设备支持（能安装微信的设备）。

node语言编写，完全遵守 MIT LICENSE。

本文档不涉及代码教程，后续如果有空我会在我的博客写一篇制作教程，欢迎访问我的博客：https://bearye.cn/



## 二、如何使用？

### 1 新建云环境

腾讯云提供一个免费方案，但是该方案不支持静态托管，可以考虑使用`Github Pages`部署网站资源，网上教程很多，这里就不多赘述了。

腾讯云cloudbase传送：https://console.cloud.tencent.com/tcb/env/index

### 2 设置云环境

1. 登录授权=》开启匿名登录。
2. 安全配置=》添加你要用的域名。
3. 数据库=》新建两个集合，分别为`talks`和`admin`，集合权限不要求但推荐选择所有用户可读，仅管理员可写。

### 3.下载源码

```
git clone https://github.com/ibearye/talk.git
```

或在Github上直接下载

### 4 修改代码

修改`cloudbaserc.json`文件中，填入你的环境id。

修改`hosting/index.html`文件里的第34行，填写你的环境id，其他按需求更改。

修改`/functions/vx/index.js`文件里的第9行和第13行：

```
...

//公众号服务器配置token值
const token = 'tokenvalues' //这里任意，英文和数字，后面需用到

//云开发初始化
tcb.init({
    env: 'envid' // 这里修改为环境id
})

...
```

### 5 布置项目到云环境

这里提供两种布置项目到云环境的方法。**5.1和5.2选其一进行操作，如果不会使用终端请直接看5.2。**

#### 5.1 使用cloudbase cli：

**前提：需要有node+npm环境**

安装cloudbase cli

```
$ npm i -g @cloudbase/cli
```

登录

```
$ tcb login
```

上传云函数

```
//vx是函数名
$ cloudbase functions:deploy vx

//如果提示未指定环境，则换用下面的命令，envid为你的环境id
$ cloudbase functions:deploy vx envid
```

上传静态资源（如果你选择的是云开发免费套餐不支持静态托管，忽略这一步）

```
$ cloudbase hosting:deploy -e 

//同样如果提示未指定环境，则换用下面的命令，envid为你的环境id
$ cloudbase hosting:deploy -e envId
```

#### 5.2 可视化操作

进入腾讯云cloudbase控制台https://console.cloud.tencent.com/tcb/env/index

上传云函数

云函数=》新建云函数=》基础信息：运行环境选择node10.15，其他任意=》函数配置：默认=》成功，到函数代码页面，提交方法选择zip包，打包`/functions/vx`文件夹内的文件上传即可（**是vx文件夹内的文件**）。

上传静态资源（如果你选择的是云开发免费套餐不支持静态托管，忽略这一步）

静态网站托管=》上传文件，上传`/hosting`文件夹内所有文件。

### 6 设置云函数触发

#### 6.1 开启http触发

云函数=》http触发=》开启http触发，关闭访问鉴权=》保存。

#### 6.2 获取函数的接口地址

刚刚上传的函数=》函数配置=》HTTP 触发路径=》填`/vx`=》保存。

保存成功后即可得到函数的触发地址。

### 7 配置微信公众号开发

#### 7.1 服务器验证

到公众号管理后台：https://mp.weixin.qq.com/

开发=》基本配置=》服务器配置=》开启，服务器地址填写函数触发地址，令牌（token）填写修改代码时设置的token值，其他默认。需要特别注意的是，本人尚未细究消息加密对服务器端处理有何影响，并且本项目无微信消息解密功能，所以消息加解密方式项慎选，推荐兼容模式。

提交，提示成功即可。本人验证过程前几次出现url超时提示，多提交几次就好了。

#### 7.2 云函数的再修改，再上传

微信公众号开发配置服务器时的验证部分，需要后端特别的响应，`/functions/vx/index.js`中第39行代码是验证用的，验证成功后需要把它删除。即：

```javascript
return event.queryStringParameters.echostr //微信公众号接入验证，验证成功后删除这一行
```

删除后再次上传云函数（参考第5步）。

### 8 使用说明

发布新内容前需要绑定用户，回复消息`//bindCurrentUser`进行绑定，绑定用户后，通过向公众号发消息即可发布新内容，但回复`//unbindCurrentUser`为解除绑定。

当无绑定用户时，任何微信用户发送消息公众号号都会响应，响应内容为“未绑定，回复 //bindCurrentUser 绑定当前账户”；当已有绑定用户时，非绑定用户无论回复什么消息公众号都不作任何响应。



## 三、项目说明

### 原理

项目实现原理很简单，代码也并不复杂，主要是3点：

1. 通过NoSQL和静态托管实现网站主体；
2. 云函数修改数据库；
3. 微信公众号开发。

### 值得一说的

**巧妙的结合**

由于腾讯云cloudbase的安全策略，虽然作为个人用户云开发无法使用微信开放平台和微信公众号进行登录授权，但云函数对同一个云环境下的数据库天然具有管理权限，无须登录授权，于是自然就把站点的后端处理交给云函数实现。另一方面，微信公众号开发中，用户一切请求都会通过微信服务器转发给用户服务器，而我们只需要在云函数中判断请求来源，这样一来，能操作数据库的只有来自微信官方请求，而我们又通过公众号给官方发送请求，最后我们只需要判断该用户身份即可。这是很巧妙的。

**代码的事**

云函数模块依赖：

1. `tcb-admin-node` 腾讯云提供的云环境管理模块，数据插入需要用到；
2. `js-sha1` 请求来源验证中，签名的生成需要进行sha1加密；
3. `xmlreader` 由于微信服务器请求携带的数据为xml格式，需要对其进行转换成json对象。

项目包中已经含有模块，如果提示错误，请用户自行安装。（勿全局安装）

### 二次开发提示

虽然项目只用于单用户，但其实扩展成多用户亦无需太多改动。NoSQL添加一个集合用于保存微信用户的`open_id`，内容集合也添加`open_id`用于表示不同用户发布的内容，云函数插入数据时添加`open_id`，而前端无需多说，提取内容时加上where判断即可。

